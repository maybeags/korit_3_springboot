# ì…ì‹¤ ì²´í¬ í•´ì£¼ì„¸ìš” !! ğŸš‘

# ë‹¤ë¥¸ ìš”ì²­ ë³´í˜¸í•˜ê¸°

20250516ì—ëŠ” ë¡œê·¸ì¸ ë‹¨ê³„ë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤. ì´ì œ ë‚˜ë¨¸ì§€ ìˆ˜ì‹  ìš”ì²­ì— ëŒ€í•œ ì¸ì¦ ì²˜ë¦¬
ì‘ì—…ì„ í•©ë‹ˆë‹¤. ì¸ì¦ í”„ë¡œì„¸ìŠ¤ì—ëŠ” ìš”ì²­ì´ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì „ë‹¬ë˜ê¸° ì „ì´ë‚˜
í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì‘ë‹µì´ ì „ì†¡ë˜ê¸° ì „ì— ì¼ë¶€ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” _í•„í„°_ ë¥¼ ì´ìš©í•©ë‹ˆë‹¤.

1. í•„í„° í´ë˜ìŠ¤ë¥¼ ì´ìš©í•˜ì—¬ ëª¨ë“  ë‹¤ë¥¸ ìˆ˜ì‹  ìš”ì²­ì„ ì¸ì¦ì²˜ë¦¬í• ê²ë‹ˆë‹¤. ë£¨íŠ¸ íŒ¨í‚¤ì§€ì—
    AuthenticationFilter í´ë˜ìŠ¤ë¥¼ ìƒì„±. í´ë˜ìŠ¤ëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì˜
    OncePerRequestFilter ì¸í„°í˜ì´ìŠ¤ë¥¼ _í™•ì¥_ (extends) í•˜ì—¬ ì¸ì¦ì„ êµ¬í˜„í•˜ëŠ”
    doFilterInternal ë©”ì„œë“œë¥¼ ì œê³µ. ìš”ì²­ì—ì„œ í† í°ì„ í™•ì¸í•˜ê¸° ìœ„í•´ í•„í„°
    í´ë˜ìŠ¤ì—ì„œ JwtService ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì£¼ì…í•´ì•¼ í•©ë‹ˆë‹¤. SecurityContextHolderë¥¼
    í†µí•˜ì—¬ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ ì¸ì¦ëœ ì‚¬ìš©ìì˜ ì„¸ë¶€ ì •ë³´ë¥¼ ì €ì¥í• ê²ë‹ˆë‹¤.

    ì½”ë“œë¥¼ í†µí•´ì„œ ì´ìƒì˜ ë©”ì„œë“œ ë° í´ë˜ìŠ¤ë“¤ì„ í™•ì¸í•˜ê² ìŠµë‹ˆë‹¤.

```java
package com.packt.cardatabase;

import com.packt.cardatabase.service.JwtService;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.http.HttpHeaders;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.Collections;

@Component
public class AuthenticationFilter extends OncePerRequestFilter {
    private final JwtService jwtService;

    public AuthenticationFilter(JwtService jwtService) {
        this.jwtService = jwtService;
    }


    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain)
            throws ServletException, IOException {
        // í† í° ê²€ì¦ ë° ì‚¬ìš©ìë¥¼ ê°€ì ¸ì˜¤ê¸° # 1
        String jws = request.getHeader(HttpHeaders.AUTHORIZATION);
        if(jws != null) {
            // í† í° ê²€ì¦ ë° ì‚¬ìš©ìë¥¼ ê°€ì ¸ì˜¤ê¸° # 2
            String user = jwtService.getAuthUser(request);
            // ì¸ì¦í•˜ê¸°
            Authentication authentication =
                    new UsernamePasswordAuthenticationToken(user, null,
                            Collections.emptyList());

            SecurityContextHolder.getContext().setAuthentication(authentication);
        }

        filterChain.doFilter(request, response);
    }
}
```

2. ìŠ¤í”„ë§ ì‹œíë¦¬í‹° config ê´€ë ¨ í•„í„° í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤. SecurityConfig í´ë˜ìŠ¤ì—
ì•„ê¹Œ ë§Œë“  AuthenticationFilter í´ë˜ìŠ¤ë¥¼ ì£¼ì…í•©ë‹ˆë‹¤.
```java
public class SecurityConfig {
    private final UserDetailsServiceImpl userDetailsService;
    //ì¶”ê°€ëœ ë¶€ë¶„
    private final AuthenticationFilter authenticationFilter;

    public SecurityConfig(UserDetailsServiceImpl userDetailsService, AuthenticationFilter authenticationFilter) {
        this.userDetailsService = userDetailsService;
        this.authenticationFilter = authenticationFilter;   // ì¶”ê°€ëœ ë¶€ë¶„
    }
}
```

3. SecurityConfig í´ë˜ìŠ¤ì—ì„œ filterChain ë©”ì„œë“œë¥¼ ìˆ˜ì •í•˜ê¸° ìœ„í•œ ê³¼ì •ì„ ê±°ì¹©ë‹ˆë‹¤.
```java
package com.packt.cardatabase;

import com.packt.cardatabase.service.UserDetailsServiceImpl;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
@EnableWebSecurity
public class SecurityConfig {
    private final UserDetailsServiceImpl userDetailsService;
    //ì¶”ê°€ëœ ë¶€ë¶„
    private final AuthenticationFilter authenticationFilter;

    public SecurityConfig(UserDetailsServiceImpl userDetailsService, AuthenticationFilter authenticationFilter) {
        this.userDetailsService = userDetailsService;
        //ì¶”ê°€ëœ ë¶€ë¶„
        this.authenticationFilter = authenticationFilter;
    }

    public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService(userDetailsService).passwordEncoder(new BCryptPasswordEncoder());
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public AuthenticationManager authenticationManager(
            AuthenticationConfiguration authConfig) throws Exception {
        return authConfig.getAuthenticationManager();
    }
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf((csrf) -> csrf.disable())
                .sessionManagement((sessionManagement) ->
                        sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests((authorizeRequests) ->
                        authorizeRequests.requestMatchers(HttpMethod.POST, "/login")
                                .permitAll().anyRequest().authenticated())
                .addFilterBefore(authenticationFilter, UsernamePasswordAuthenticationFilter.class); // ì¶”ê°€ëœ ë¶€ë¶„

        return http.build();
    }
}
```
4. ì „ì²´ workflow í…ŒìŠ¤íŠ¸ ì¤€ë¹„ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ í›„(ì˜¤ë¥˜ë‚˜ë©´ ìˆ˜ì •í•˜ëŸ¬ê°€ê² ìŠµë‹ˆë‹¤),
POST ë©”ì„œë“œë¡œ /login ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œí•˜ì—¬ ë¡œê·¸ì¸ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤(ê¸ˆìš”ì¼ ë§ˆì§€ë§‰ì— í•œ ë¶€ë¶„).
ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ Authorization í—¤ë”ì— JWTë¥¼ ë°›ê²Œ ë©ë‹ˆë‹¤.
```json
{"username": "user", "password": "user"},

{"username": "admin", "password": "admin"}
```
ìœ¼ë¡œ ë¡œê·¸ì¸í–ˆì„ ë•Œì…ë‹ˆë‹¤. postmanìœ¼ë¡œ ìë™ìœ¼ë¡œ ì§€ì •ë˜ì§€ ì•ŠëŠ” ê²½ìš°ëŠ”
Content-Type í—¤ë”ë¥¼ application/jsonìœ¼ë¡œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.















